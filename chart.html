<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard (Local File)</title>
    
    <!-- å¼•å…¥å¿…è¦çš„ Library -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://unpkg.com/technicalindicators/dist/browser.js"></script>

    <style>
        body { background-color: #111; color: #eee; font-family: sans-serif; margin: 0; padding: 20px; }
        .controls { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: #222; 
            border-radius: 8px; 
            border: 1px solid #333;
        }
        input[type="file"] { color: #ddd; }
        #chart { width: 100%; height: 800px; border: 1px solid #333; }
        .status { margin-left: 10px; color: #aaa; font-size: 0.9em; }
    </style>
</head>
<body>

    <div class="controls">
        <h3>ğŸ“‚ é¸æ“‡æœ¬åœ° JSON æª”æ¡ˆ (ç„¡éœ€ä¼ºæœå™¨)</h3>
        <!-- æª”æ¡ˆé¸æ“‡å™¨ -->
        <input type="file" id="fileInput" accept=".json">
        <span id="status" class="status">ç­‰å¾…é¸æ“‡æª”æ¡ˆ...</span>
    </div>

    <div id="chart"></div>

    <script>
        // --- 1. åˆå§‹åŒ–åœ–è¡¨ä½ˆå±€ (Layout) ---
        const chartContainer = document.getElementById('chart');
        const chart = LightweightCharts.createChart(chartContainer, {
            layout: { background: { color: '#111' }, textColor: '#DDD' },
            grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
            rightPriceScale: { borderColor: '#333' },
            timeScale: { borderColor: '#333', timeVisible: true, secondsVisible: false },
        });

        // å»ºç«‹ä¸‰å€‹è¦–çª— (Pane)
        // Pane 1: ä¸»åœ– (Kç·š + VWAP)
        const candleSeries = chart.addCandlestickSeries({ upColor: '#089981', downColor: '#F23645' });
        const vwapSeries = chart.addLineSeries({ color: '#FF9800', lineWidth: 2, title: 'VWAP' });

        // Pane 2: MACD (ç¨ç«‹åº§æ¨™)
        const macdHistogram = chart.addHistogramSeries({ 
            color: '#26a69a', 
            priceFormat: { type: 'volume' }, 
            priceScaleId: 'macd', 
        });
        const macdLine = chart.addLineSeries({ color: '#2962FF', lineWidth: 1, priceScaleId: 'macd' });
        const signalLine = chart.addLineSeries({ color: '#FF6D00', lineWidth: 1, priceScaleId: 'macd' });

        // Pane 3: RSI (ç¨ç«‹åº§æ¨™)
        const rsiSeries = chart.addLineSeries({ 
            color: '#A485FF', 
            lineWidth: 2, 
            priceScaleId: 'rsi',
            title: 'RSI'
        });

        // è¨­å®šè¦–çª—é«˜åº¦æ¯”ä¾‹ (Stacked)
        chart.priceScale('macd').applyOptions({
            scaleMargins: { top: 0.65, bottom: 0.15 }, // ä½”æ“šåº•éƒ¨ä¸­é–“
        });
        chart.priceScale('rsi').applyOptions({
            scaleMargins: { top: 0.85, bottom: 0 }, // ä½”æ“šæœ€åº•éƒ¨
        });

        // --- 2. è™•ç†æª”æ¡ˆè®€å– (File Reader) ---
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const jsonContent = event.target.result;
                    const rawData = JSON.parse(jsonContent);
                    document.getElementById('status').innerText = `âœ… å·²è¼‰å…¥: ${file.name}`;
                    renderChart(rawData);
                } catch (err) {
                    console.error(err);
                    alert("JSON æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹ï¼");
                }
            };

            reader.readAsText(file);
        });

        // --- 3. ç¹ªåœ–é‚è¼¯ (èˆ‡ä¹‹å‰ç›¸åŒ) ---
        function renderChart(rawData) {
            // æ¸…ç©ºèˆŠæ•¸æ“š (å¦‚æœæœ‰) - Lightweight Charts æ²’æœ‰ç›´æ¥ clearï¼Œç”¨ setData([]) è¦†è“‹
            candleSeries.setData([]); vwapSeries.setData([]); 
            macdHistogram.setData([]); macdLine.setData([]); signalLine.setData([]); 
            rsiSeries.setData([]);

            // æº–å‚™æ•¸æ“šå®¹å™¨
            const candles = [];
            const vwapData = [];
            const closes = [];
            const timestamps = [];

            // è§£ææ•¸æ“š
            rawData.forEach(d => {
                // æ™‚é–“æ ¼å¼è™•ç†ï¼šå¦‚æœæ˜¯æ¯«ç§’ (13ä½æ•¸)ï¼Œè½‰ç‚ºç§’ (10ä½æ•¸)
                const time = d.timestamp > 10000000000 ? d.timestamp / 1000 : d.timestamp;
                
                candles.push({ time, open: d.open, high: d.high, low: d.low, close: d.close });
                if(d.vwap) vwapData.push({ time, value: d.vwap });
                
                closes.push(d.close);
                timestamps.push(time);
            });

            // å¡«å…¥ä¸»åœ–æ•¸æ“š
            candleSeries.setData(candles);
            vwapSeries.setData(vwapData);

            // --- è¨ˆç®— RSI (14) ---
            const rsiPeriod = 14;
            const rsiResult = technicalindicators.RSI.calculate({
                values: closes,
                period: rsiPeriod
            });
            
            // RSI å°é½Šä¿®æ­£
            const rsiChartData = rsiResult.map((val, index) => ({
                time: timestamps[index + rsiPeriod], 
                value: val
            }));
            rsiSeries.setData(rsiChartData);

            // --- è¨ˆç®— MACD (12, 26, 9) ---
            const macdInput = {
                values: closes,
                fastPeriod: 12, slowPeriod: 26, signalPeriod: 9,
                SimpleMAOscillator: false, SimpleMASignal: false
            };
            const macdResult = technicalindicators.MACD.calculate(macdInput);

            // MACD å°é½Šä¿®æ­£ (MACD åˆå§‹é•·åº¦æœƒå°‘æ–¼ slowPeriod)
            const macdOffset = timestamps.length - macdResult.length;
            const macdHistData = [];
            const macdLineData = [];
            const signalLineData = [];

            macdResult.forEach((d, i) => {
                const time = timestamps[i + macdOffset];
                if (time) {
                    const color = (d.histogram > 0) ? 
                        (d.histogram > (macdResult[i-1]?.histogram || 0) ? '#00E676' : '#69F0AE') : // æ¼²å‹¢å¼·/å¼±ç¶ 
                        (d.histogram < (macdResult[i-1]?.histogram || 0) ? '#FF1744' : '#FF5252');   // è·Œå‹¢å¼·/å¼±ç´…
                    
                    macdHistData.push({ time, value: d.histogram, color: color });
                    macdLineData.push({ time, value: d.MACD });
                    signalLineData.push({ time, value: d.signal });
                }
            });

            macdHistogram.setData(macdHistData);
            macdLine.setData(macdLineData);
            signalLine.setData(signalLineData);
            
            // è‡ªå‹•ç¸®æ”¾åœ–è¡¨ä»¥é©æ‡‰æ•¸æ“š
            chart.timeScale().fitContent();
        }
    </script>
</body>
</html>
